// filiali.js - visualizzazione "Interventi Giornalieri"
// - Usa data/filiali.json (se presente) o preferisce la copia in localStorage (chi salva può scaricare e poi sostituire il file nella repo).
// - Mostra solo le righe con almeno un campo non vuoto.
// - Oggi viene sempre mostrato in cima.

(function(){
  const DATA_URL = 'data/filiali.json';
  const MAX_ROWS_PER_DAY = 8;
  const LOCAL_KEY = 'filiali_data_custom'; // se esiste, ha priorità sulla data/filiali.json

  function todayKey(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function formatDateKey(key){
    const [y,m,d] = key.split('-');
    return `${d}/${m}/${y}`;
  }

  async function fetchJSON(url){
    try {
      const res = await fetch(url, { cache: "no-cache" });
      if(!res.ok) throw new Error('fetch failed');
      return await res.json();
    } catch(e){
      return {};
    }
  }

  function isEntryEmpty(e){
    return !(e.localita || e.banca || e.km || e.materiali || e.ac);
  }

  function ensureToday(data){
    const t = todayKey();
    if(!data[t]) {
      data[t] = [];
    }
    // ensure array length up to MAX_ROWS_PER_DAY but not necessary; we'll show only saved entries
    if(!Array.isArray(data[t])) data[t] = [];
  }

  function sortDatesWithTodayFirst(keys){
    const t = todayKey();
    const others = keys.filter(k => k !== t).sort((a,b) => b.localeCompare(a)); // descending
    if(keys.includes(t)) return [t, ...others];
    return [...others];
  }

  function render(data){
    const container = document.getElementById('daysContainer');
    container.innerHTML = '';
    const keys = Object.keys(data).filter(k => Array.isArray(data[k]) && data[k].some(e => !isEntryEmpty(e)));
    if(keys.length === 0){
      document.getElementById('empty').style.display = 'block';
      return;
    } else {
      document.getElementById('empty').style.display = 'none';
    }
    const ordered = sortDatesWithTodayFirst(keys);
    for(const k of ordered){
      const entries = (data[k] || []).filter(e => !isEntryEmpty(e));
      if(entries.length === 0) continue;
      const section = document.createElement('section');
      section.className = 'day-block';
      const header = document.createElement('h3');
      header.className = 'day-header';
      header.innerText = `${formatDateKey(k)}`;
      section.appendChild(header);

      const table = document.createElement('table');
      table.className = 'table daily-table';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>#</th><th>Località</th><th>Banca</th><th>Km</th><th>Materiali installati</th><th>A/C</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');

      entries.forEach((entry, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(entry.localita)}</td>
          <td>${escapeHtml(entry.banca)}</td>
          <td>${escapeHtml(entry.km)}</td>
          <td>${escapeHtml(entry.materiali)}</td>
          <td>${escapeHtml(entry.ac)}</td>
        `;
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      section.appendChild(table);
      container.appendChild(section);
    }
  }

  function escapeHtml(text){
    if(!text && text!==0) return '';
    return String(text).replace(/[&<>"'`]/g, (s) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;', '`':'&#96;'
    })[s]);
  }

  // prefer localStorage saved copy if present (così dopo che admin salva in locale si vede subito)
  async function loadAndRender(){
    let data = {};
    const local = localStorage.getItem(LOCAL_KEY);
    if(local){
      try { data = JSON.parse(local); ensureToday(data); render(data); return; } catch(e){ /* fallthrough */ }
    }
    data = await fetchJSON(DATA_URL);
    ensureToday(data);
    render(data);
  }

  // button admin -> apre filiali-admin.html
  function setupAdminButton(){
    const adminBtn = document.getElementById('adminBtn');
    if(adminBtn) adminBtn.addEventListener('click', () => {
      // apri la pagina di admin (che chiede password)
      window.location.href = 'filiali-admin.html';
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupAdminButton();
    loadAndRender();
  });
})();
